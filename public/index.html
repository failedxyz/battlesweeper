<html>
	<head>
		<title>Lobby</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js" integrity="sha384-RSXe9j39thYJayrqYBX6YfS7IV4bsKWZ9eEMYN+CLnB5pUyGAlXbUG/zWLqB62Na" crossorigin="anonymous"></script>
		<script src="https://cdn.socket.io/socket.io-1.4.5.js" integrity="sha384-mp5QqlF7YJplkggFgto52+zx2bKkCQPFNvJWia1rhnEpwcXieUOcgRoLncV3M4NO" crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js" integrity="sha384-uEKJZcjXxYuCnOPvqTQP6vj69jWPkWzo0YISzCKa0UKHGJp7QpcphU3tW4Whc/bZ" crossorigin="anonymous"></script>
		<script src="Minsweeper.js"></script>
		<link rel="icon" href="img/logo.png" />
		<style>
			@font-face {
				font-family: "Proxima Nova";
				src: url("/fonts/ProximaNova.woff2");
			}
			@font-face {
				font-family: "Proxima Nova";
				src: url("/fonts/ProximaNovaBold.woff2");
				font-weight: bold;
			}
			*::selection {
				background-color: #7B1AF3;
				color: #FFF;
			}
			body, html {
				margin: 0;
				padding: 0;
				overflow: hidden;
				font-family: "Proxima Nova";
				font-weight: normal;
			}
			.cell {
				display: inline-block;
				width: 32px;
				height: 32px;
				line-height: 32px;
				text-align: center;
				border-top: 1px solid #999;
				border-right: 1px solid #999;
				text-decoration: none;
				font-family: monospace;
				font-size: 16pt;
				background-color: #AAA;
			}
			.flag {
				color: #900;
			}
			.covered {
				background-color: #CCC !important;
			}
			.blank {
				background-color: #999;
			}
			.number {
				font-weight: bold;
			}
			.num1 {
				color: #009;
			}
			.num2 {
				color: #090;
			}
			.num3 {
				color: #900;
			}
			.num4 {
				color: #003;
			}
			.num5 {
				color: #300;
			}
			.num6 {
				color: #066;
			}
			.num7 {
				color: #000;
			}
			.num8 {
				color: #999;
			}
			#lobby {
				background-color: #F8F8F8;
				height: 100%;
			}
			#lobby #userpanel {
				position: absolute;
				top: 0;
				left: 0;
				width: 25%;
				height: 100%;
				padding: 0;
				background-color: #F0F0F0;
			}
			#lobby #userpanel #logo {
				padding: 20px;
				box-sizing: border-box;
				width: 100%;
				text-align: center;
				height: 120px;
				line-height: 80px;
				background-color: #FFFFFF;
				vertical-align: middle;
				margin: 0;
			}
			#lobby #userpanel h2 {
				padding: 20px;
				box-sizing: border-box;
				width: 100%;
				background-color: #F6F6F6;
				margin: 0;
			}
			#usercount {
				padding: 5px;
				box-sizing: border-box;
				font-size: 0.75em;
				font-weight: normal;
				display: inline-block;
				float: right;
			}
			#challenge_button {
				display: inline-block;
				float: right;
				color: #FFF;
				font-size: 0.65em;
				padding: 5px;
				text-decoration: none;
				background-color: #090;
				transition: all .2s ease-out;
				-o-transition: all .2s ease-out;
				-ms-transition: all .2s ease-out;
				-moz-transition: all .2s ease-out;
				-webkit-transition: all .2s ease-out;
			}
			#challenge_button:hover {
				background-color: #0A0;
			}
			#challenge_button:active {
				background-color: #080;
			}
			#lobby #chatpanel {
				position: absolute;
				top: 0;
				right: 0;
				width: 75%;
				height: 100%;
			}
			#lobby #chatpanel #chatmessages {
				height: calc(100% - 80px);
				overflow-y: scroll;
				background-color: #F8F8F8;
				box-sizing: border-box;
				padding: 20px;
			}
			#lobby #chatpanel #message {
				font-family: "Proxima Nova";
				height: 80px;
				background-color: #F1F1F1;
				border: none;
				border-top: 1px solid #999;
				outline: none;
				width: 100%;
				padding: 30px;
				font-size: 16pt;
			}
			#lobby #chatpanel #message:focus {
				background-color: #FFF;
				transition: all .2s ease-out;
				-o-transition: all .2s ease-out;
				-ms-transition: all .2s ease-out;
				-moz-transition: all .2s ease-out;
				-webkit-transition: all .2s ease-out;
			}
			#board {
				padding: 30px;
			}
			#overlay {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: 1000;
				background-color: rgba(0, 0, 0, 0.5);
			}
			#overlay #countdown {
				position: absolute;
				top: 50%;
				left: 0;
				width: 100%;
				text-align: center;
				color: #FFF;
				font-weight: bold;
				font-size: 3em;
				transform: translateY(-50%);
			}
			#messagelist th, #messagelist td {
				font-size: 1.25em;
				padding: 10px;
			}
			td.timestamp {
				font-style: italic;
				color: #666;
			}
		</style>
	</head>
	<body>
		<div id="lobby">
			<div id="userpanel">
				<div id="logo">
					<img src="img/logo.png" style="width: 60px; height: 60px; vertical-align: middle; margin-right: 10px;" />
					<h1 style="display: inline; vertical-align: middle;">BattleSweeper</h1>
				</div>
				<h2>Users
					<span id="usercount"></span>
				</h2>
				<ul id="users"></ul>
				<h2>Challenges
					<a href="javascript:create_challenge();" id="challenge_button">Create Challenge</a>
				</h2>
				<ul id="challenges"></ul>
			</div>
			<div id="chatpanel">
				<div id="chatmessages">
					<table id="messagelist"></table>
				</div>
				<form onsubmit="javascript:send_message();return false;">
					<input type="text" id="message" placeholder="Type a message..." autofocus autocomplete="off" />
				</form>
			</div>
		</div>
		<div id="board" style="display:none;">
			<h2>Play</h2>
			<div id="toolbar">
				Mines: <span id="mines"></span>
				Time: <span id="time"></span>
				<div style="float:right;">
					(Opponent)
					Mines: <span id="opp_mines"></span>
					Time: <span id="opp_time"></span>
				</div>
			</div>
			<center>
				<div id="actual_board" style="display:inline-block;"></div>
			</center>
		</div>
		<div id="overlay" style="display:none;">
			<div id="countdown">COUNTDOWN</div>
		</div>
		<script type="text/javascript">
			var socket = io();
			var username, player, gid;
			var time, startTime, prevTime = 0, mines;
			var game;
			socket.emit("lobby/join", {}, function(error, message) {
				username = message;
				socket.on("lobby/users", function(users) {
					var userlist = document.getElementById("users");
					userlist.innerHTML = "";
					for(var i=0; i<users.length; i++) {
						var user = users[i];
						var userElement = document.createElement("li");
						userElement.innerHTML = user["username"];
						if (user["username"] == username) userElement.style.fontWeight = "bold";
						if (user["in_game"] == true) userElement.style.fontStyle = "italic";
						if (user["username"] == username && user["in_game"] == true) start_game();
						userlist.appendChild(userElement);
					}
					document.getElementById("usercount").innerHTML = users.length + " user" + ((users.length != 1) ? "s" : "") + " online";
				});
				socket.on("lobby/challenges", function(challenges) {
					var challengelist = document.getElementById("challenges");
					challengelist.innerHTML = "";
					for(var i=0; i<challenges.length; i++) {
						var challenge = challenges[i];
						var challengeElement = document.createElement("li");
						if (challenge["sender"] == username) {
							challengeElement.innerHTML = challenge["sender"];
						} else {
							var challengeLink = document.createElement("a");
							challengeLink.innerHTML = challenge["sender"];
							challengeLink.href = "javascript:accept_challenge('" + challenge["sender"] + "');";
							challengeElement.appendChild(challengeLink);
						}
						challengelist.appendChild(challengeElement);
					}
				});
				socket.on("game/over", function(data) {
					if (data["winner"] == username) {
						alert("You win!");
					} else {
						alert("You lose :(");
					}
					$("#lobby").show();
					$("#board").hide();
				});
				socket.on("lobby/message", function(data) {
					var row = document.createElement("tr");
					var col0 = document.createElement("td");
					col0.innerHTML = moment(data["timestamp"] + 2705000 /*hack*/, "x").add(moment().utcOffset(), "minutes").format("LT");
					col0.className = "timestamp";
					col0.style.minWidth = "90px";
					col0.style.textAlign = "right";
					var col1 = document.createElement("th");
					col1.innerHTML = data["sender"];
					var col2 = document.createElement("td");
					col2.innerHTML = data["message"];
					col2.style.overflowX = "hidden";
					col2.style.whiteSpace = "nowrap";
					row.appendChild(col0);
					row.appendChild(col1);
					row.appendChild(col2);
					document.getElementById("messagelist").appendChild(row);
					var objDiv = document.getElementById("chatmessages");
					objDiv.scrollTop = objDiv.scrollHeight;
				});
				window.create_challenge = function() {
					socket.emit("lobby/challenge", {}, function(error, message) {
						// console.log("Created challenge!");
					});
				};
				window.accept_challenge = function(sender) {
					socket.emit("lobby/accept", { "sender": sender }, function(error, message) {
						start_game();
					});
				};
				window.set_board = function(board) {
					var toHtml = function(n) {
						switch (n) {
							case -2:
								return ["cell covered", "<span class='flag'>&#x2691;</span>"];
							case -1:
								return ["cell covered", "<span></span>"];
							case 0:
								return ["cell", "<span class='blank'></a>"];
							case 1: case 2: case 3: case 4: case 5: case 6: case 7: case 8:
								return ["cell", "<span class='number num" + n + "'>" + n + "</span>"];
							default:
								break;
							/*case -2:
								return "<img src='img/flag-mine.png' />";
							case -1:
								return "<img src='img/covered.png' />";
							case 0:
								return "<img src='img/empty.png' />";
							case 1: case 2: case 3: case 4: case 5: case 6: case 7: case 8:
								return "<img src='img/number-" + n + ".png' />";
							default:
								break;*/
						}
					};
					var width = game["width"], height = game["height"];
					var html = "<table border=0 cellspacing=0 cellpadding=0>";
					for(var j=0; j<height; j++) {
						html += "<tr>";
						for(var i=0; i<width; i++) {
							var k = j*height + i;
							html += "<td>";
							var X = toHtml(board[k]);
							html += "<a class='" + X[0] + "' href='javascript:click_square(" + k + ");' id='cell" + k + "'>" + X[1] + "</a>";
							html += "</td>";
						}
						html += "</tr>";
					}
					html += "</table>";
					$("#actual_board").html(html);
					for(var j=0; j<height; j++) {
						for(var i=0; i<width; i++) {
							var k = j*height + i;
							(function(i, j, k) {
								document.getElementById("cell" + k).oncontextmenu = function(e) {
									e.preventDefault();
									console.log(i + ", " + j);
									if (time >= 0) {
										/* console.log(game.flag(j, i));
										set_board(game.getBoard()); */
										// $("#mines").html(mines);
										flag_square(k);
									}
									return false;
								}
							})(i, j, k);
						}
					}
				};
				window.click_square = function(k) {
					var i = k % game["height"];
					var j = ~~(k / game["height"]);
					if (time >= 0) {
						if (game.getBoard()[k] == -1) {
							game.open(j, i);
						} else {
							game.chord(j, i);
						}
						set_board(game.getBoard());
						game_state = game.getState();
						if (game_state == 2 || game_state == 3) {
							game_over();
						}
					}
				};
				window.flag_square = function(k) {
					var i = k % game["height"];
					var j = ~~(k / game["height"]);
					game.flag(j, i);
					mines = game.mines - game.board.flagged;
					$("#mines").html(mines);
					set_board(game.getBoard());
					return false;
				};
				window.game_over = function() {
					var status = game.getState();
					var cb = function(error, message) {
					};
					var data = {
						gid: gid,
						result: game.getState() - 2,
						player: player
					};
					if (game.getState() == Minsweeper.DIED) {
						socket.emit("game/lose", data, cb);
					} else if (game.getState() == Minsweeper.COMPLETED) {
						socket.emit("game/win", data, cb);
					}
				};
				window.frame = function() {
					time = ~~(new Date().getTime() / 1000.0) - startTime;
					$("#time").html(time);
					if (time < 0) {
						$("#countdown").html(-1 * time);
					} else {
						$("#overlay").hide();
					}
					if (time != prevTime) {
						if (time == 0) $("#overlay").hide();
						socket.emit("game/update", {
							gid: gid,
							from: username,
							player: player,
							mines: mines,
							time: time
						});
					}
					prevTime = time;
					requestAnimationFrame(frame);
				};
				window.start_game = function() {
					$("#lobby").hide();
					$("#board").show();
					$("#overlay").show();
					time = 0;
					socket.on("game/init", function(data) {
						console.log(data);
						gid = data["gid"];
						if (data["player1"] == username) player = "player1";
						else if (data["player2"] == username) player = "player2";
						game = new Minsweeper(15, 15, 20, { }, parseInt(data["gid"].toLowerCase(), 36) % 15700);
						var mines = game["mines"];
						$("#mines, #opp_mines").html(mines);
						$("#time, #opp_time").html(0);
						startTime = data["start_time"];
						set_board(game.getBoard());
						requestAnimationFrame(frame);
					});
					socket.on("game/update", function(data) {
						var opp = player == "player1" ? "player2" : "player1";
						$("#opp_mines").html(data[opp]["mines"]);
						$("#opp_time").html(data[opp]["time"]);
					});
				};
				window.send_message = function() {
					var message = $("#message").val();
					socket.emit("lobby/message", { message: message }, function() {
						$("#message").val("");
					});
				};
			});
		</script>
	</body>
</html>
